function getAttributeProperties(t,e){var a=UNDERSCORE+e+ATTRIBUTE_PROPERTIES;return t.hasOwnProperty(a)?t[a]:Object.defineProperty(t,a,{enumerable:!1,configurable:!1,writable:!0,value:Object.create(getAttributeProperties(Object.getPrototypeOf(t),e))})[a]}require("collections/shim"),require("./shim/object"),require("./shim/array"),require("./shim/string"),require("./extras/object"),require("./extras/date"),require("./extras/element"),require("./extras/function"),require("./extras/regexp"),require("./extras/string");var deprecate=require("./deprecate"),ATTRIBUTE_PROPERTIES="AttributeProperties",UNDERSCORE="_",PROTO="__proto__",VALUE="value",ENUMERABLE="enumerable",DISTINCT="distinct",SERIALIZABLE="serializable",MODIFY="modify",ARRAY_PROTOTYPE=Array.prototype,OBJECT_PROTOTYPE=Object.prototype,CONSTRUCTOR_COMPATIBILITY=!0,Montage=exports.Montage=function Montage(){};Montage.deprecate=deprecate.deprecateMethod(Montage,deprecate.deprecateMethod,"Montage.deprecate","deprecate module's deprecateMethod"),Montage.callDeprecatedFunction=deprecate.deprecateMethod(Montage,deprecate.callDeprecatedFunction,"Montage.callDeprecatedFunction","deprecate module's callDeprecatedFunction");var PROTO_IS_SUPPORTED={}.__proto__===Object.prototype,PROTO_PROPERTIES_BLACKLIST={_montage_metadata:1,__state__:1},FUNCTION_PROPERTIES=Object.getOwnPropertyNames(Function);if(Object.defineProperty(Montage,"specialize",{value:function(t,e){var a,n,s,i,l,r,c,o=this,h=this.specialize===void 0;if(t=t||Object.empty,e=e||Object.empty,a=t.constructor&&t.constructor.value?t.constructor.value:t.didCreate&&t.didCreate.value?Montage.deprecate(null,t.didCreate.value,"didCreate","constructor"):function(){return this.superForValue("constructor")()||this},PROTO_IS_SUPPORTED)a.__proto__=o;else{s=Object.getOwnPropertyNames(o);for(var r=0;s.length>r;r++)i=s[r],PROTO_PROPERTIES_BLACKLIST.hasOwnProperty(i)||(l=Object.getOwnPropertyDescriptor(a,i),(!l||l.configurable)&&Montage.defineProperty(a,i,Object.getOwnPropertyDescriptor(o,i)));a.__constructorProto__=o,Montage.defineProperty(a,"isPrototypeOf",{value:function(t){for(;null!==t;){if(Object.getPrototypeOf(t)===this)return!0;t=Object.getPrototypeOf(t)}return!1},enumerable:!1})}if(n=Object.create(this.prototype),h){for(s=Object.getOwnPropertyNames(Montage),r=0;s.length>r;r++)i=s[r],l=Object.getOwnPropertyDescriptor(a,i),(!l||l.configurable)&&Montage.defineProperty(a,i,Object.getOwnPropertyDescriptor(Montage,i));for(s=Object.getOwnPropertyNames(Montage.prototype),r=0;s.length>r;r++)i=s[r],l=Object.getOwnPropertyDescriptor(a,i),(!l||l.configurable)&&Montage.defineProperty(n,i,Object.getOwnPropertyDescriptor(Montage.prototype,i))}if(Montage.defineProperties(n,t),CONSTRUCTOR_COMPATIBILITY){c=function(t,e,a){function n(){return this===e&&deprecate.deprecationWarning(Montage.getInfoForObject(e).objectName+"."+a+" should be moved to constructorProperties",null,3),t.apply(this,arguments)}return n.deprecatedFunction=t,n};for(i in t)FUNCTION_PROPERTIES.has(i)?delete t[i]:(l=t[i],l.value&&"function"==typeof l.value&&!l.value.__isConstructor__?l.value=c(l.value,a,i):(l.get&&(l.get=c(l.get,a,i)),l.set&&(l.set=c(l.set,a,i))));Montage.defineProperties(a,t),Montage.defineProperty(a,"create",{value:function(){return new a},enumerable:!1})}return Montage.defineProperties(a,e),Montage.defineProperty(a,"__isConstructor__",{value:!0,enumerable:!1}),Montage.defineProperty(a,"_superCache",{value:{},enumerable:!1}),a.prototype=n,Montage.defineProperty(n,"constructor",{value:a,enumerable:!1}),a},writable:!0,configurable:!0,enumerable:!1}),!PROTO_IS_SUPPORTED){var originalGetPrototypeOf=Object.getPrototypeOf;Object.getPrototypeOf=function(t){return"function"==typeof t&&t.__constructorProto__?t.__constructorProto__:originalGetPrototypeOf.apply(Object,arguments)}}Object.defineProperty(Montage,"create",{configurable:!0,value:function(t,e){if(void 0!==t&&"object"!=typeof t&&"function"!=typeof t)throw new TypeError("Object prototype may only be an Object or null, not '"+t+"'");if(t=t===void 0?this:t,"function"==typeof t)return e?t.specialize(e):new t;var a=Object.create(t);return e&&Montage.defineProperties(a,e),a}});var extendedPropertyAttributes=[SERIALIZABLE];extendedPropertyAttributes.forEach(function(t){Object.defineProperty(Object.prototype,UNDERSCORE+t+ATTRIBUTE_PROPERTIES,{enumerable:!1,configurable:!1,writable:!0,value:{}})}),Object.defineProperty(Montage,"defineProperty",{value:function(t,e,a){if("object"!=typeof t&&"function"!=typeof t||null===t)throw new TypeError("Object must be an object, not '"+t+"'");var n=VALUE in a;if(DISTINCT in a&&!n)throw new TypeError("Cannot use distinct attribute on non-value property '"+e+"'");if(PROTO in a)a.__proto__=n?"function"==typeof a.value?_defaultFunctionValueProperty:_defaultObjectValueProperty:_defaultAccessorProperty;else{var s;s=n?"function"==typeof a.value?_defaultFunctionValueProperty:_defaultObjectValueProperty:_defaultAccessorProperty;for(var i in s)i in a||(a[i]=s[i])}if(a.hasOwnProperty(ENUMERABLE)||e.charAt(0)!==UNDERSCORE||(a.enumerable=!1),a.hasOwnProperty(SERIALIZABLE)||(a.enumerable?a.get&&!a.set?a.serializable=!1:a.writable===!1&&(a.serializable=!1):a.serializable=!1),SERIALIZABLE in a&&(getAttributeProperties(t,SERIALIZABLE)[e]=a.serializable),a.distinct!==!0||"object"!=typeof a.value){var l,r,c;if(t._superDependencies){if("function"==typeof a.value&&(l=t._superDependencies[e+".value"]))for(r=0,c=l.length;c>r;r++)delete l[r]._superCache[e+".value"];if("function"==typeof a.get&&(l=t._superDependencies[e+".get"]))for(r=0,c=l.length;c>r;r++)delete l[r]._superCache[e+".get"];if("function"==typeof a.set&&(l=t._superDependencies[e+".set"]))for(r=0,c=l.length;c>r;r++)delete l[r]._superCache[e+".set"]}return Object.defineProperty(t,e,a)}(function(t,e,a,n){var s=function(t,e,a){Object.defineProperty(t,e,{enumerable:!1,configurable:!0,writable:!0,value:a})};a.constructor===Object&&Object.getPrototypeOf(a)===OBJECT_PROTOTYPE?0!==Object.keys(a).length?Object.defineProperty(n,t,{configurable:!0,get:function(){var t=this[e];if(!t){var n;t={};for(n in a)t[n]=a[n];this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}return t},set:function(t){this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}}):Object.defineProperty(n,t,{configurable:!0,get:function(){var t=this[e];return t||(t={},this.hasOwnProperty(e)?this[e]=t:s(this,e,t)),t},set:function(t){this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}}):(a.__proto__||Object.getPrototypeOf(a))===ARRAY_PROTOTYPE?0!==a.length?Object.defineProperty(n,t,{configurable:!0,get:function(){var t=this[e];if(!t){var n,i;for(t=[],n=0;(i=a[n])!==void 0;n++)t[n]=i;this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}return t},set:function(t){this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}}):Object.defineProperty(n,t,{configurable:!0,get:function(){var t=this[e];return t||(t=[],this.hasOwnProperty(e)?this[e]=t:s(this,e,t)),t},set:function(t){this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}}):a.constructor.prototype===Object.getPrototypeOf(a)?Object.defineProperty(n,t,{configurable:!0,get:function(){var t=this[e];if(!t){var n;t=new a.constructor;for(n in a)t[n]=a[n];this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}return t},set:function(t){this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}}):Object.defineProperty(n,t,{configurable:!0,get:function(){var t=this[e];return t||(t=Object.create(a.__proto__||Object.getPrototypeOf(a)),this.hasOwnProperty(e)?this[e]=t:s(this,e,t)),t},set:function(t){this.hasOwnProperty(e)?this[e]=t:s(this,e,t)}})})(e,UNDERSCORE+e,a.value,t)}}),Object.defineProperty(Montage,"defineProperties",{value:function(t,e){if("object"!=typeof e||null===e)throw new TypeError("Properties must be an object, not '"+e+"'");for(var a in e)"_bindingDescriptors"!==a&&this.defineProperty(t,a,e[a]);return t}});var _defaultAccessorProperty={enumerable:!0,configurable:!0,serializable:!0},_defaultObjectValueProperty={writable:!0,enumerable:!0,configurable:!0,serializable:"reference"},_defaultFunctionValueProperty={writable:!0,enumerable:!1,configurable:!0,serializable:!1};Montage.defineProperty(Montage,"didCreate",{value:Function.noop});var getSuper=function(t,e){var a,n,s,i,l,r,c,o,h;if(!e._superPropertyName||!e._superPropertyType)for(Montage.defineProperty(e,"_superPropertyType",{value:null}),Montage.defineProperty(e,"_superPropertyName",{value:null}),c=t;!o&&null!==c;){for(a=Object.getOwnPropertyNames(c),n=Object.getPrototypeOf(c),s=0,i=a.length,s;i>s;s++){if(l=a[s],h=Object.getOwnPropertyDescriptor(c,l),null!=(r=h.value)&&(r===e||r.deprecatedFunction===e)){e._superPropertyType="value",e._superPropertyName=l,o=!0;break}if(null!=(r=h.get)&&(r===e||r.deprecatedFunction===e)){e._superPropertyType="get",e._superPropertyName=l,o=!0;break}if(null!=(r=h.set)&&(r===e||r.deprecatedFunction===e)){e._superPropertyType="set",e._superPropertyName=l,o=!0;break}}c=n}return superForImplementation(t,e._superPropertyType,e._superPropertyName)},superImplementation=function(){if("function"!=typeof superImplementation.caller)throw new TypeError("Can't get super without caller. Use this.superForValue(methodName) if using strict mode.");var t=getSuper(this,superImplementation.caller);return"function"==typeof t?t.bind(this):Function.noop},superForImplementation=function(t,e,a){var n,s,i,l,r,c=t,o=a+"."+e;if(t._superContext||Montage.defineProperty(t,"_superContext",{value:{}}),t._superContext[o])c=t._superContext[o];else for(c=t;null!==c&&(!c.hasOwnProperty(a)||(i=Object.getOwnPropertyDescriptor(c,a),"function"!=typeof i[e]));)c=Object.getPrototypeOf(c);if(l=c.constructor,l._superCache&&l._superCache[o])return r=function(t,e,a,n){return function(){e._superContext[t]=a;var s=n.apply(e,arguments);return delete e._superContext[t],s}}(o,t,l._superCache[o].owner,l._superCache[o].func);for(s=c;n===void 0&&(s=Object.getPrototypeOf(s));)if(s._superDependencies||Montage.defineProperty(s,"_superDependencies",{value:{}}),s._superDependencies[o]||(s._superDependencies[o]=[]),s._superDependencies[o].push(l),i=Object.getOwnPropertyDescriptor(s,a)){if("function"==typeof i[e]){n=i[e];break}break}return"function"==typeof n?(r=function(t,e,a,n){return function(){e._superContext[t]=a;var s=n.apply(e,arguments);return delete e._superContext[t],s}}(o,t,s,n),l._superCache||Montage.defineProperty(l,"_superCache",{value:{}}),l._superCache[o]={func:n,owner:s},r):Function.noop},superForValueImplementation=function(t){return superForImplementation(this,"value",t)},superForGetImplementation=function(t){return superForImplementation(this,"get",t)},superForSetImplementation=function(t){return superForImplementation(this,"set",t)};Montage.defineProperty(Montage,"super",{get:superImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"super",{get:superImplementation,enumerable:!1}),Montage.defineProperty(Montage,"superForValue",{value:superForValueImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"superForValue",{value:superForValueImplementation,enumerable:!1}),Montage.defineProperty(Montage,"superForGet",{value:superForGetImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"superForGet",{value:superForGetImplementation,enumerable:!1}),Montage.defineProperty(Montage,"superForSet",{value:superForSetImplementation,enumerable:!1}),Montage.defineProperty(Montage.prototype,"superForSet",{value:superForSetImplementation,enumerable:!1}),Montage.defineProperty(Montage,"getSerializablePropertyNames",{value:function(t){var e=[],a=t._serializableAttributeProperties;if(a)for(var n in a)a[n]&&e.push(n);return e}}),Montage.defineProperty(Montage,"getPropertyAttribute",{value:function(t,e,a){var n=UNDERSCORE+a+ATTRIBUTE_PROPERTIES,s=t[n];return s?s[e]:void 0}}),Montage.defineProperty(Montage,"getPropertyAttributes",{value:function(t,e){var a={},n=UNDERSCORE+e+ATTRIBUTE_PROPERTIES,s=t[n];if(s){for(var i in s)a[i]=s[i];return a}}});var _instanceMetadataDescriptor={isInstance:{value:!0}},_functionInstanceMetadataDescriptor={objectName:{value:"Function"},isInstance:{value:!0}};Montage.defineProperty(Montage,"getInfoForObject",{value:function(t){var e,a;if(hasOwnProperty.call(t,"_montage_metadata"))return t._montage_metadata;if(e=t._montage_metadata||t.constructor&&t.constructor._montage_metadata||null,a=t.constructor===Function?_functionInstanceMetadataDescriptor:_instanceMetadataDescriptor,t===Object.prototype)return Object.create(e,a);try{return Object.defineProperty(t,"_montage_metadata",{enumerable:!1,writable:!0,value:Object.create(e,a)})._montage_metadata}catch(n){return t._montage_metadata=Object.create(e,a)}}});var UUID=require("./uuid");"undefined"!=typeof window&&(window.uuid=UUID.generate());var hasOwnProperty=Object.prototype.hasOwnProperty,uuidGetGenerator=function(){var t=UUID.generate(),e=Montage.getInfoForObject(this);try{null!==e&&e.isInstance===!1?(this._uuid=t,Object.defineProperty(this,"uuid",{get:function(){return this.hasOwnProperty("uuid")?this._uuid:uuidGetGenerator.call(this)}})):(e.isInstance&&Object.defineProperty(this,"uuid",{configurable:!0,enumerable:!1,writable:!1,value:t}),!(this instanceof Element)&&e.isInstance&&VALUE in(Object.getOwnPropertyDescriptor(this,"uuid")||{})&&PROTO in this||(this._uuid=t))}catch(a){}return this._uuid=t,t},defaultUuidGet=function defaultUuidGet(){return hasOwnProperty.call(this,"_uuid")?this._uuid:uuidGetGenerator.call(this)};Object.defineProperty(Object.prototype,"_uuid",{enumerable:!1,value:null,writable:!0}),Object.defineProperty(Object.prototype,"uuid",{configurable:!0,get:defaultUuidGet,set:function(){}}),Montage.defineProperty(Montage,"identifier",{value:null,serializable:!0}),Montage.defineProperty(Montage.prototype,"identifier",{value:null,serializable:!0}),Montage.defineProperty(Montage.prototype,"equals",{value:function(t){return t?this===t||this.uuid===t.uuid:!1}}),Montage.defineProperty(Montage,"equals",{value:Montage.prototype.equals}),Montage.defineProperty(Montage.prototype,"callDelegateMethod",{value:function(t){var e,a,n=this.delegate;return"string"==typeof this.identifier&&(e=this.identifier+t.toCapitalized(),n&&"function"==typeof(a=n[e]))?(ARRAY_PROTOTYPE.shift.call(arguments),a.apply(n,arguments)):n&&"function"==typeof(a=n[t])?(ARRAY_PROTOTYPE.shift.call(arguments),a.apply(n,arguments)):void 0}});var PropertyChanges=require("collections/listen/property-changes");Object.addEach(Montage,PropertyChanges.prototype),Object.addEach(Montage.prototype,PropertyChanges.prototype);var Bindings=exports.Bindings=require("frb"),bindingPropertyDescriptors={defineBinding:{value:function(t,e,a){return Bindings.defineBinding(this,t,e,a)}},defineBindings:{value:function(t,e){return Bindings.defineBindings(this,t,e)}},cancelBinding:{value:function(t){return Bindings.cancelBinding(this,t)}},cancelBindings:{value:function(){return Bindings.cancelBindings(this)}},getBinding:{value:function(t){return Bindings.getBinding(this,t)}},getBindings:{value:function(){return Bindings.getBindings(this)}}};Montage.defineProperties(Montage,bindingPropertyDescriptors),Montage.defineProperties(Montage.prototype,bindingPropertyDescriptors);var WeakMap=require("collections/weak-map"),Map=require("collections/map"),parse=require("frb/parse"),evaluate=require("frb/evaluate"),assign=require("frb/assign"),observe=require("frb/observe"),bind=require("frb/bind"),compileObserver=require("frb/compile-observer"),Scope=require("frb/scope"),Observers=require("frb/observers"),autoCancelPrevious=Observers.autoCancelPrevious,pathChangeDescriptors=new WeakMap,pathPropertyDescriptors={getPath:{value:function(t,e,a,n){return evaluate(t,this,e||this,a,n)}},setPath:{value:function(t,e,a,n,s){return assign(this,t,e,a||this,n,s)}},observePath:{value:function(t,e){var a=parse(t),n=compileObserver(a);return n(autoCancelPrevious(e),new Scope(this))}},addRangeAtPathChangeListener:{value:function(t,e,a,n,s,i){function l(t,n,s){if(e[a])e[a](t,n,s);else{if(!e.call)throw Error("Can't dispatch range change to "+e);e.call(null,t,n,s)}}a=a||"handleRangeChange";var r=[];return this.addPathChangeListener(t,function(t){return t&&t.toArray&&t.addRangeChangeListener?(l(t.toArray(),r.toArray(),0),r=t,t.addRangeChangeListener(l)):(t=[],l(t,r,0),r=t,void 0)},void 0,void 0,n,s,i)}},getPathChangeDescriptors:{value:function(){return pathChangeDescriptors.has(this)||pathChangeDescriptors.set(this,{}),pathChangeDescriptors.get(this)}},getPathChangeDescriptor:{value:function(t,e,a){var n=Montage.getPathChangeDescriptors.call(this);return Object.owns(n,t)||(n[t]={willChangeListeners:new Map,changeListeners:new Map}),n=n[t],n=a?n.willChangeListeners:n.changeListeners,n.has(e)||n.set(e,{path:t,handler:e,beforeChange:a,cancel:Function.noop}),n.get(e)}},addPathChangeListener:{value:function(t,e,a,n,s,i,l){var r=this;e=e||Function.noop;var c=Montage.getPathChangeDescriptor.call(this,t,e,n);c.cancel();var o,h,g,p=parse(t);if(e===Function.noop)g=function(e){if(h)throw Error("Path change handler needs a handler because it emits new values when the source changes: "+JSON.stringify(t));h=!0,o=e};else if(a)g=function(n){return e[a].call(e,n,t,r)};else if(e.handlePathChange)g=function(a){return e.handlePathChange.call(e,a,t,r)};else{if("function"!=typeof e)throw Error("Can't recognize handler type: "+e+". Must be function or delegate implementing handlePathChange.");g=function(a){return e.call(r,a,t,r)}}var d=compileObserver(p),m=new Scope(this);m.beforeChange=n,m.parameters=s,m.document=i,m.components=l;var L=d(autoCancelPrevious(g),m);return c.cancel=L,h?o:L}},removePathChangeListener:{value:function(t,e,a){e=e||Function.noop;var n=Montage.getPathChangeDescriptors.call(this),s=a?"willChangeListeners":"changeListeners";if(!Object.owns(n,t))throw Error("Can't find "+s+" for "+JSON.stringify(t));var i=n[t],l=i[s];if(!l.has(e))throw Error("Can't find "+s+" for "+JSON.stringify(t));var r=l.get(e);r.cancel(),l["delete"](e),0===i.willChangeListeners.length&&0===i.changeListeners.length&&delete n[t];for(var c in n)return;pathChangeDescriptors["delete"](this)}},addBeforePathChangeListener:{value:function(t,e,a,n,s,i){return Montage.addPathChangeListener.call(this,t,e,a,!0,n,s,i)}},removeBeforePathChangeListener:{value:function(t,e){return Montage.removePathChangeListener.call(this,t,e,!0)}}};Montage.defineProperties(Montage,pathPropertyDescriptors),Montage.defineProperties(Montage.prototype,pathPropertyDescriptors),require("./serialization/bindings"),exports._blueprintModuleIdDescriptor={serializable:!1,enumerable:!1,get:function(){var t=Montage.getInfoForObject(this),e=t&&!t.isInstance?this:this.constructor;if(!Object.getOwnPropertyDescriptor(e,"_blueprintModuleId")||!e._blueprintModuleId){t=Montage.getInfoForObject(e);var a=t.moduleId,n=a.lastIndexOf("/"),s=a.lastIndexOf(".");n=-1===n?0:n+1,s=-1===s?a.length:s,s=n>s?a.length:s,Montage.defineProperty(e,"_blueprintModuleId",{enumerable:!1,value:a.slice(0,s)+".meta"})}return e._blueprintModuleId}},exports._blueprintDescriptor={serializable:!1,enumerable:!1,get:function(){var t=Montage.getInfoForObject(this),e=t&&!t.isInstance?this:this.constructor;if(!Object.getOwnPropertyDescriptor(e,"_blueprint")||!e._blueprint){var a=e.blueprintModuleId;if(""===a)throw new TypeError("Blueprint moduleId undefined for the module '"+JSON.stringify(e)+"'");exports._blueprintDescriptor.BlueprintModulePromise||(exports._blueprintDescriptor.BlueprintModulePromise=require.async("core/meta/module-blueprint").get("ModuleBlueprint")),Montage.defineProperty(e,"_blueprint",{enumerable:!1,value:exports._blueprintDescriptor.BlueprintModulePromise.then(function(t){var n=Montage.getInfoForObject(e);return t.getBlueprintWithModuleId(a,n.require).fail(function(a){if(-1!==a.message.indexOf("Can't XHR"))return t.createDefaultBlueprintForObject(e).then(function(t){return t});throw a})})})}return e._blueprint},set:function(t){var e,a=Montage.getInfoForObject(this),n=a&&!a.isInstance?this:this.constructor;if(null===t)e=null;else{if("function"==typeof t.then)throw new TypeError("Object blueprint should not be a promise");t.blueprintInstanceModule=n.blueprintModule,e=require("./promise").Promise.resolve(t)}Montage.defineProperty(n,"_blueprint",{enumerable:!1,value:e})}};