montageDefine("7a1ec3b","core/undo-manager",{dependencies:["./core","./target","./promise","collections/map","collections/list"],factory:function(e,t){var n=e("./core").Montage,i=e("./target").Target,r=e("./promise").Promise,a=e("collections/map"),s=e("collections/list"),l=0,o=1,c=t.UndoManager=i.specialize({_operationQueue:{value:null},_promiseOperationMap:{value:null},constructor:{value:function c(){this._operationQueue=[],this._promiseOperationMap=new a,this._undoStack=new s,this._redoStack=new s,this._batchStack=new s,this.defineBinding("undoLabel",{"<-":"undoEntry.label || _promiseOperationMap.get(_undoStack.head.prev.value).label"}),this.defineBinding("undoCount",{"<-":"length",source:this._undoStack}),this.defineBinding("canUndo",{"<-":"!!length",source:this._undoStack}),this.defineBinding("isUndoing",{"<-":"!!undoEntry"}),this.defineBinding("redoLabel",{"<-":"redoEntry.label || _promiseOperationMap.get(_redoStack.head.prev.value).label"}),this.defineBinding("redoCount",{"<-":"length",source:this._redoStack}),this.defineBinding("canRedo",{"<-":"!!length",source:this._redoStack}),this.defineBinding("isRedoing",{"<-":"!!redoEntry"}),this.defineBinding("currentBatch",{"<-":"_batchStack.head.prev.value"})}},_maxUndoCount:{enumerable:!1,value:null},maxUndoCount:{get:function(){return this._maxUndoCount},set:function(e){e!==this._maxUndoCount&&(this._maxUndoCount=e,null!=this._maxUndoCount&&this._trimStacks())}},_undoStack:{value:null},undoCount:{value:0},_redoStack:{value:null},redoCount:{value:0},_trimStacks:{enumerable:!1,value:function(){var e=this._undoStack.length-this._maxUndoCount,t=this._redoStack.length-this._maxUndoCount;e>0&&this._undoStack.splice(0,e),t>0&&this._redoStack.splice(0,t)}},registrationEnabled:{value:!0},_batchStack:{value:null},currentBatch:{value:null},openBatch:{value:function(e){var t={};t.label=e,t.promisedOperations=[],this._batchStack.push(t)}},closeBatch:{value:function(){if(!this.currentBatch)throw Error("No batch operation to close");var e,t=this.currentBatch.label,n=this.currentBatch.promisedOperations,i=[],a=function(){e=Object.create(null),this.openBatch(t);var n=i.reduceRight(function(t,n){return t.then(function(){return l._resolveUndoEntry(e,n),e.undoFunction.apply(e.context,e.args)})},r.resolve());return n.finally(function(){l.closeBatch()})},s=n.reduce(function(e,t){return e.then(function(e){return e&&i.push(e),t})},r.resolve());this._batchStack.pop();var l=this;this.register(t,s.then(function(e){return i.push(e),[a,l]}))}},register:{value:function(e,t){var n,i=this;if(!r.isPromiseAlike(t))throw Error("UndoManager expected a promise");if(0===this._maxUndoCount||!this.registrationEnabled)return r.resolve(null);if(this.currentBatch)this.currentBatch.promisedOperations.push(t),n=t;else{var a={label:e};this._promiseOperationMap.set(t,a),this.isUndoing?(a.label=this.undoLabel,this._redoStack.length===this._maxUndoCount&&this._redoStack.shift(),this._redoStack.push(t)):(this._undoStack.length===this._maxUndoCount&&this._undoStack.shift(),this._undoStack.push(t),!this.isRedoing&&this._redoStack.length>0&&this.clearRedo()),this.isUndoing||this.isRedoing||this.dispatchEventNamed("operationRegistered",!0,!1),n=t.then(function(e){return i._resolveUndoEntry(a,e),a}).then(function(){return i._flushOperationQueue()})}return n}},_resolveUndoEntry:{value:function(e,t){var n,i,r,a;if("string"==typeof t[0]?(n=t[0],i=t[1],r=t[2],a=3):(i=t[0],r=t[1],a=2),n&&(e.label=n),"function"!=typeof i)throw Error("Need undo function for '"+e.label+"' operation, not: "+i);e.undoFunction=i,e.context=r,e.args=t.slice(a)}},_flushOperationQueue:{value:function(){var e,t=this._operationQueue,n=t.length,i=[],a=this._promiseOperationMap,s=this;if(0!==n){var l=!1,o=t.reduce(function(e,t){var n=s._promiseOperationMap.get(t);return l||"function"!=typeof n.undoFunction?(l=!0,e):(i.push(t),e.then(function(){return s._performOperation(n)}).then(function(){a.delete(t)}))},r.resolve());return e=i.length,e>0&&t.splice(0,e),o}}},_performOperation:{value:function(e){var t=this;e.operationType===l?this.undoEntry=e:this.redoEntry=e;var n;try{n=e.undoFunction.apply(e.context,e.args)}catch(i){throw e.deferredOperation.reject(i),i}return r.isPromiseAlike(n)?n.finally(function(){t.undoEntry=null,t.redoEntry=null}).then(function(t){e.deferredOperation.resolve(t)},function(t){e.deferredOperation.reject(t)}):(this.undoEntry=null,this.redoEntry=null,e.deferredOperation.resolve(n),void 0)}},clearUndo:{value:function(){this._undoStack.splice(0,this._undoStack.length)}},clearRedo:{value:function(){this._redoStack.splice(0,this._redoStack.length)}},isUndoing:{value:!1},isRedoing:{value:!1},undoEntry:{enumerable:!1,value:null},redoEntry:{enumerable:!1,value:null},undo:{value:function(){if(0===this.undoCount)return r.resolve(null);var e=this;return this._scheduleOperation(this._undoStack.pop(),l).then(function(t){return e.dispatchEventNamed("undo",!0,!1,t),t})}},redo:{value:function(){if(0===this.redoCount)return r.resolve(null);var e=this;return this._scheduleOperation(this._redoStack.pop(),o).then(function(t){return e.dispatchEventNamed("redo",!0,!1),t})}},_scheduleOperation:{value:function(e,t){var n=r.defer(),i=this._promiseOperationMap.get(e);return i.deferredOperation=n,i.operationType=t,this._operationQueue.push(e),this._flushOperationQueue().thenResolve(n.promise)}},canUndo:{value:null},canRedo:{value:null},undoLabel:{value:null},redoLabel:{value:null}}),u=null;n.defineProperty(t,"defaultUndoManager",{get:function(){return u||(u=new c),u}})}});