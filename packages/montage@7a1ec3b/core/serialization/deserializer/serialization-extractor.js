var Montage=require("../../core").Montage,MontageReviver=require("./montage-reviver").MontageReviver,parse=require("frb/parse"),SerializationExtractor=Montage.specialize({_serialization:{value:null},initWithSerialization:{value:function(t){this._serialization=t}},extractObjects:{value:function(t,e){var n=this._serialization,r={};e=e||[];for(var i,a=0;i=t[a];a++)i in n&&(r[i]=n[i],this._findLabels(i,e));for(var i,a=0;i=e[a];a++)!(i in r)&&i in n&&(r[i]={});return JSON.parse(JSON.stringify(r))}},_findLabels:{value:function(t,e){var n;if(-1===e.indexOf(t)){if(!(t in this._serialization))throw Error("Object '"+t+"' not found.");e.push(t),n=this._serialization[t],this._collectLabels(n,e),this._collectLabelsInUnits(n,e)}}},_collectLabels:{value:function(t,e){var n,r=MontageReviver.getTypeOf(t);if("reference"===r)n=t["@"],this._findLabels(n,e);else if("array"===r)for(var i=0,a=t.length;a>i;i++)this._collectLabels(t[i],e);else if("object"===r)for(var s in t)this._collectLabels(t[s],e)}},_collectLabelsInUnits:{value:function(t,e){"bindings"in t?this._collectLabelsInBindings(t.bindings,e):"localizations"in t&&this._collectLabelsInLocalizations(t.localizations,e)}},_collectLabelsInBindings:{value:function(t,e){var n,r;for(var i in t)n=t[i],r=n["<-"]||n["<->"],this._collectLabelsInBindingPath(r,e)}},_collectLabelsInBindingPath:{value:function(t,e){var n=this,r=parse(t);this._traverseBindingParseTree(r,function(t){n._findLabels(t.label,e)})}},_traverseBindingParseTree:{value:function(t,e){var n=t.args;if("component"===t.type&&e(t),n)for(var r=0,i=n.length;i>r;r++)this._traverseBindingParseTree(n[r],e)}},_collectLabelsInLocalizations:{value:function(t,e){for(var n in t)this._collectLabelsInLocalizationProperty(t[n],e)}},_collectLabelsInLocalizationProperty:{value:function(t,e){var n;if("key"in t&&this._collectLabelsInLocalizationBinding(t.key,e),"default"in t&&this._collectLabelsInLocalizationBinding(t.default,e),"data"in t){n=t.data;for(var r in n)this._collectLabelsInLocalizationBinding(n[r],e)}}},_collectLabelsInLocalizationBinding:{value:function(t,e){var n=t["<-"]||t["<->"];n&&this._collectLabelsInBindingPath(n,e)}}});exports.SerializationExtractor=SerializationExtractor;